---
title: "MATP-4400 COVID-19 Final Notebook"
author: "Daniel Tabin"
date: "May 6 2020"
output:
  html_document:
    number_sections: yes
    toc: yes
    toc_depth: 2
  pdf_document:
    toc: yes
    toc_depth: '2'
---

```{r setup, include=FALSE}
# stick libraries here
knitr::opts_chunk$set(echo = TRUE)
library(dplyr)

```

# Final Project: Guidance for Students (DELETE)

*DELETE THIS SECTION IN FINAL NOTEBOOK!*

##GENERAL INSTRUCTIONS (DELETE)##

* This notebook serves as a written presentation of your work so it should be written like a research paper.
* The rubric for evaluating this project is on LMS.
* The R code that executes the results should be embedded in this notebook if possible. It's also okay to "source" external scripts from within your notebook, including those provided by your instructors. 
* If there is work that is not appropriate to be embedded on your final notebook, then you can describe the work in the notebook and provide figures generated elsewhere (e.g. screen shots, graphs). Indicate if that work has been committed to github. If necessary put details in Appendix.    
* Your wording should be suitable for sharing with external partners/mentors and useful to future contributors.
* Please don't summarize everything you did; discuss only the *most important* aspects of your work. Ask yourself *what really matters?*
* IMPORTANT: Discuss any insights you found regarding COVID-19.
* If there are limitations to your work, discuss. 
* Include any background or support for your work. For example, mention any relevant research articles you found -- and be sure to include references!
* Include your recommendations for extending the COVIDMINDER app:
    + Data utilization...
    + Analytics...
    + Visualizations
    + User interface design...
* **Expect internet problems!** Commit versions of this notebook to the IDEA github *early and often*. You can continue to refine and update; that is the point of github!

##SUBMISSION CHECKLIST: Things to check before you submit (DELETE)##

* Have you given your file(s) a clear, sensible name? `my_notebook.Rmd` or `joey.Rmd` are **not* acceptable!
* Is every figure clearly labeled and titled? 
* Does every figure serve a purpose? 
     + What question does it answer? 
     + You can put extra (non-essential) figues in the Appendix.
* Are your tables clearly labelled and legible?
     + We recommend using `kable()` (built into `knitr`)
     + `xtable()` might also work for you (not as easy as `kable()`)
* **CRITICAL:** Have you given enough information for someone to reproduce, understand and extend your results?
     + Where can they *find* the data that you used?
     + Have you *described* the data that used?
     + Have you *documented* your code? 
     + Are your figures *clearly labeled*?
     + Did you *discuss your findings*?
     + Did you use good grammar and *proofread* your results?
     + Finally, have you *committed* your work to github and made a *pull request*?
     
## github Submission Instructions (DELETE!)

Fill out the bullets at the beginning of this notebook...

* Provide your github ID. 
* Indicate the issues associated with this work on github. 
* Commit the Rmd and html versions of this notebook to the `MATP-4400-FINAL` directory on github and make a pull request.  
* Provide the link to your github submission on LMS. 
    + **NOTE:** You can post your link any time after it exists  
    + We will grade the latest version available on Github starting at 3:00 on Thursday, 7 May.  
* **NOTE:** RStudio Server will be unavailable due to maintenance for up to a week beginning the weekend of 9 May,  so there can be no extensions or late submissions. 

##github help (DELETE!)

* DO THIS FIRST:
    + `git clone https://github.com/TheRensselaerIDEA/COVID-Notebooks` (if you haven't already)
        + NOTE: We may have added to the master since your last `git pull` so make sure to do a `git pull origin master`
    + `git checkout -b <your-new-branch>` (more instructions immediately below)
    + In R, create a new R notebook (ie a `.Rmd` file) in the subdirectory `MATP-4400-FINAL`
    + `git add` it to the repo (make sure you're in the correct directory when you do this!)
    + `git commit -a -m 'Created my notebook!'` as soon as you do this! 
    + `git push origin <your-new-branch>` so we see you're working on something
    + Post a link in LMS; it will remain valid as you update (and check in) your work to github
    + for details, see instructions in next few bullets
    + Contact John Erickson erickj4@rpi.edu for further github questions
* See: **HOW TO USE THIS NOTEBOOK AND REPOSITORY** https://bit.ly/2wYQGXP
* See also: **git Cheat Sheet** https://bit.ly/2yCBSi8 

*DELETE THE SECTIONS ABOVE!*
<hr>

# Final Project: Submission Links

*This should be the first section of your final project notebook. Fill out the following according to how you submitted your notebook!*

* github repository: https://github.com/TheRensselaerIDEA/COVID-Notebooks/tree/state-report-card-daniel-tabin-project 
* My github ID: *Darokrithia*
* github issues addressed by this work: `#31` (example)
* Github branch name of my submitted notebook: *state-report-card-daniel-tabin-project* (example)
* link to merged notebook (post these to LMS!: 
    + https://github.com/TheRensselaerIDEA/COVID-Notebooks/blob/state-report-card-daniel-tabin-project/MATP-4400-FINAL/COVID_FINAL_2020_Daniel_Tabin.Rmd (example; Rmd version)
    + https://github.com/TheRensselaerIDEA/COVID-Notebooks/blob/state-report-card-daniel-tabin-project/MATP-4400-FINAL/COVID_FINAL_2020_Daniel_Tabin.html (example; HTML version)

# Overview & Problems Tackled

*Provide a top-level summary of your work and findings.*
Problem 1 what is important for covid
Problem 2 can we make an explanitory report card?

# Data Description

*Include data sources/locations, versions/dates, etc.* 
Original:
at_risk_adults.csv
uninsured_by_state.csv
states_abbreviations.csv
provider_capacity.csv
hypertension_mortality.csv
diabetes_data_states.csv
covid_data_states.csv
New:
time_series_covid19_deaths_US.csv
time_series_covid19_confirmed_US.csv

# Results

*Break out your results by each problem you attacked*

## Problem 1 

*Describe the problem you are examining.  If there is background that is necessary for this problem, then put it here. Include any references.* 

 
### Methods
Load in data
```{r}
at_risk_adults <- read.csv('../data/csv/at_risk_adults.csv')
uninsured_by_state <- read.csv('../data/csv/uninsured_by_state.csv', row.names = NULL)
states_abbreviations<- read.csv('../data/csv/states_abbreviations.csv')
provider_capacity <- read.csv('../data/csv/provider_capacity.csv')
hypertension_mortality <- read.csv('../data/csv/hypertension_mortality.csv')
diabetes_data_states <- read.csv('../data/csv/diabetes_data_states.csv')
covid_data_states <- read.csv('../data/csv/covid_data_states.csv')


time_series_covid19_deaths_US <- read.csv('../data/csv/time_series/time_series_covid19_deaths_US.csv')
time_series_covid19_confirmed_US <- read.csv('../data/csv/time_series/time_series_covid19_confirmed_US.csv')

```

```{r}
colnames(uninsured_by_state) = c("NAME", "Status", "Employer", "Non-group", "Medicaid", "Medicare", "Military", "Uninsured", "number_uninsured")
names(diabetes_data_states)[names(diabetes_data_states) == 'State'] <- 'NAME'

master_data <- merge(at_risk_adults, uninsured_by_state, by="NAME")
master_data <- merge(master_data, states_abbreviations, by="NAME", type="inner")
master_data <- merge(master_data, provider_capacity, by="NAME", type="inner")
master_data <- merge(master_data, hypertension_mortality, by="NAME", type="inner")
master_data <- merge(master_data, diabetes_data_states, by="NAME", type="inner")
master_data <- merge(master_data, covid_data_states, by="NAME", type="inner")


names(time_series_covid19_confirmed_US)[names(time_series_covid19_confirmed_US) == 'Province_State'] <- 'NAME'
names(time_series_covid19_deaths_US)[names(time_series_covid19_deaths_US) == 'Province_State'] <- 'NAME'
latest_confirmed <- time_series_covid19_confirmed_US [ , c(7, ncol(time_series_covid19_confirmed_US), ncol(time_series_covid19_confirmed_US)-1)] 
latest_deaths <- time_series_covid19_deaths_US [ , c(7, ncol(time_series_covid19_deaths_US), ncol(time_series_covid19_deaths_US)-1)]

names(latest_confirmed)[3] <- 'prev_c'
names(latest_deaths)[3] <- 'prev_d'
names(latest_confirmed)[2] <- 'total_c'
names(latest_deaths)[2] <- 'total_d'

latest_deaths$daily_deaths <- (latest_deaths$total_d - latest_deaths$prev_d)
latest_confirmed$daily_confirmed <- (latest_confirmed$total_c - latest_confirmed$prev_c)

latest_deaths <- latest_deaths[, c("NAME", "daily_deaths")]
latest_confirmed <- latest_confirmed[, c("NAME", "daily_confirmed")]

latest_confirmed <- aggregate(latest_confirmed['daily_confirmed'], by=latest_confirmed['NAME'], sum)
latest_deaths <- aggregate(latest_deaths['daily_deaths'], by=latest_deaths['NAME'], sum)

master_data <- merge(master_data, latest_confirmed, by="NAME", type="inner")
master_data <- merge(master_data, latest_deaths, by="NAME", type="inner")

head(master_data)
```

```{r}
gradable_data <- master_data[, c("p_at_risk_adults", "p_older_at_risk_adults", "Uninsured", "hosp_beds_per_1000", "p_ht_death_rate", "pct_Adults_with_Diabetes")]
colnames(gradable_data) = c("At risk Adults", "Older at risk Adults", "Uninsured", "Hospital Beds", "Heart Disease", "Diabetes")
head(gradable_data)
gradable_data2 <- master_data[, c("p_at_risk_adults", "p_older_at_risk_adults", "Uninsured", "hosp_beds_per_1000", "p_ht_death_rate", "pct_Adults_with_Diabetes", "covid19_cases", "covid19_deaths")]
colnames(gradable_data2) = c("At risk Adults", "Older at risk Adults", "Uninsured", "Hospital Beds", "Heart Disease", "Diabetes", "Covid Cases", "Covid Deaths")

gradable_data3 <- master_data[, c("p_at_risk_adults", "p_older_at_risk_adults", "Uninsured", "hosp_beds_per_1000", "p_ht_death_rate", "pct_Adults_with_Diabetes", "daily_confirmed", "daily_deaths")]
colnames(gradable_data3) = c("At risk Adults", "Older at risk Adults", "Uninsured", "Hospital Beds", "Heart Disease", "Diabetes", "Covid Cases", "Covid Deaths")
```
```{r}
set.seed(300)
km <-kmeans(scale(data.matrix(gradable_data)), 5)
km$cluster <- as.character(km$cluster)
my.pca <- prcomp(scale(data.matrix(gradable_data)), retx=TRUE, center=TRUE, scale=TRUE)
# Calculate x and y scale limits for the biplot
t<-max(abs(my.pca$x[,1:2]))
# Generate the biplot using ggbiplot
p <- ggbiplot(my.pca,
            choices=c(1,2),
            varname.adjust=0.5,
            obs.scale = 1,
            groups=as.factor(km$cluster))
p + ggtitle('First two PCs of gradable data') + xlim(-t,t) + ylim(-t,t)
p <- ggbiplot(my.pca,
            choices=c(2,3),
            varname.adjust=0.5,
            obs.scale = 1,
            groups=as.factor(km$cluster))
p + ggtitle('Second two PCs of gradable data') + xlim(-t,t) + ylim(-t,t)
heatmap.2(km$centers, 
          scale = "none",
          dendrogram = "none",
          Colv=FALSE,
          cexCol=0.5,
          main = "Heatmap of gradable features",
          trace ="none")

km2 <-kmeans(scale(data.matrix(gradable_data2)), 5)
km2$cluster <- as.character(km$cluster)
my2.pca <- prcomp(scale(data.matrix(gradable_data2)), retx=TRUE, center=TRUE, scale=TRUE)
# Calculate x and y scale limits for the biplot
t<-max(abs(my2.pca$x[,1:2]))
# Generate the biplot using ggbiplot
p <- ggbiplot(my2.pca,
            choices=c(1,2),
            varname.adjust=0.5,
            obs.scale = 1,
            groups=as.factor(km2$cluster))
p + ggtitle('First two PCs of gradable data (including COVID data)') + xlim(-t,t) + ylim(-t,t)
p <- ggbiplot(my2.pca,
            choices=c(2,3),
            varname.adjust=0.5,
            obs.scale = 1,
            groups=as.factor(km2$cluster))
p + ggtitle('Second two PCs of gradable data (including COVID data)') + xlim(-t,t) + ylim(-t,t)
heatmap.2(km2$centers, 
          scale = "none",
          dendrogram = "none",
          Colv=FALSE,
          cexCol=0.5,
          main = "Heatmap of gradable features (including COVID data)",
          trace ="none")



km3 <-kmeans(scale(data.matrix(gradable_data3)), 5)
km3$cluster <- as.character(km$cluster)
my3.pca <- prcomp(scale(data.matrix(gradable_data3)), retx=TRUE, center=TRUE, scale=TRUE)
# Calculate x and y scale limits for the biplot
t<-max(abs(my3.pca$x[,1:2]))
# Generate the biplot using ggbiplot
p <- ggbiplot(my3.pca,
            choices=c(1,2),
            varname.adjust=0.5,
            obs.scale = 1,
            groups=as.factor(km3$cluster))
p + ggtitle('First two PCs of gradable data (including latest COVID data)') + xlim(-t,t) + ylim(-t,t)
p <- ggbiplot(my3.pca,
            choices=c(2,3),
            varname.adjust=0.5,
            obs.scale = 1,
            groups=as.factor(km3$cluster))
p + ggtitle('Second two PCs of gradable data (including latest COVID data)') + xlim(-t,t) + ylim(-t,t)
heatmap.2(km3$centers, 
          scale = "none",
          dendrogram = "none",
          Colv=FALSE,
          cexCol=0.5,
          main = "Heatmap of gradable features (including latest COVID data)",
          trace ="none")
```

*How did you address the problem? What data did you use exactly? What methods did you use?* 

	
### Results

*What were the results on this problem?*


### Discussion

*Interpret results.  What were your findings?  What do they say about COVID-19?   What are the strengths and limitations of these results? Is there support for your findings from other sources? Include references as appropriate.*

## Problem 2
 
### Methods
	
### Results

### Discussion

*Do at least 2 problems. Add more as necessary *


# Summary and COVIDMINDER Recommendations

* Overall, what insights did you find  about the  COVID-19 epidemic in your analysis?    

* What recommendations do you have for COVIDMINDER for  Data utilization, Analytics, Visualizations, User interface design, etc.

    + Would you recommend that your analysis be included in COVIDMINDER?  Why or Why not?  
    + If not, is there additional work that might  improve the results?  Note that it is perfectly okay for you to recommend to not to include your analysis. Research doesn't always work out.  As a team we need to try a lot of different ideas in hopes of finding a few good ones to pursue.  *

*Think of yourself as a consultant reporting back on a particular aspect of the analysis and application design!*

# References

*Include any references to literature in support of your work*
*You might also wish to include references to unusual R packages essential to your work*

# Appendix

*Include here whatever you think is relevant to support the main content of your notebook. For example, you may have only include example figures above in your main text but include additional ones here* 


