---
title: "COVID-19 Relevant Social Determinants and Risk Factors at the County Level"
author: "Yue Chen"
date: "5/5/2020"
output:
  pdf_document: default
  html_document: default
Github ID: omniaquaecumque
---

## Overview

As of May 5, 2020, New York State still has the highest number of confirmed cases than any other states in the U.S. There have been 1,029,000 tests, of which there were 321,200 confirmed cases, and 19,645 people have died. We know that the spread of coronavirus is more likely when people are in close contact withon another. Older people who have severe underlying medical conditions like lung disease or diabetes seem to be at higher risk for developing more serious symptoms. One may wonder if the fatality rate at county level is also related to these risk factors. This notebook thus analyzes and maps some of the county level social determinants and risk factors like percentage smokers, percentage adults with diabetes, median household income etc. to see if they are related to the fatality rate.


**Preparation:** .

```{r setup, include=FALSE}
if (!require("maps")) {
   install.packages("maps")
   library(maps)
}
if (!require("devtools")) {
   install.packages("devtools")
   library(devtools)
}
if (!require("tidyverse")) {
   install.packages("tidyverse")
   library(tidyverse)
}
if (!require("urbnmapr")) {
   devtools::install_github("UrbanInstitute/urbnmapr")
   library(urbnmapr)
}
if (!require("urbnthemes")) {
   devtools::install_github("UrbanInstitute/urbnthemes")
   library(urbnthemes)
}
knitr::opts_chunk$set(echo = TRUE)
```
## Table of Content
* Mapping NY County Health Outcomes & Factors Rankings
* Mapping NY County Covid-19 Fatality Rate
* Building Linear Regression Model for Fatality Rate
* Mapping NY County Health Outcomes & Factors Subrankings
* Mapping NY County Health Outcomes & Factors Measures
* Mapping NY County Health Outcomes & Factors Additional Measures
* Building Linear Regression Model with Measures
* Conclusion and Discussion


## Mapping NY County Health Outcomes & Factors Rankings		
The 2020 county Health Rankings State Reports is a collaboration between the Robert Wood Johnson Foundation and the University of Wisconsin Population Health Institute. This section maps the health outcomes and health factors z-score of the NY counties. The health outcomes are calculated based on length of life, and quality of life data collected from year 2012-2018. The health factors are calculated based upon health behaviors, clinical care, social & economic factors, physical environment, and demographics data from year 2010-2018. 
Data is downloaded from https://www.countyhealthrankings.org/.
```{r}
# Read in the NY county factor data
NYfactor <- read.csv('NY2020County.csv')
# Convert fips column from numeric type to character
NYfactor <- transform(NYfactor, county_fips = as.character(county_fips))
# Combine geometry features to work with map
counties_sf <- get_urbn_map(map = "counties", sf = TRUE)
counties_sf <- counties_sf[counties_sf$state_abbv=="NY",]
healthFactor <- left_join(counties_sf, NYfactor, by = "county_fips")
# Map NY Health outcome Zscore
healthFactor %>%
  ggplot() +
    geom_sf(mapping = aes(fill = Z.Score),
                 color = NA, size = 0.05)+
    geom_sf_text(data = healthFactor, 
                aes(label = County), size = 2)+ 
  ggtitle("New York County 2020 Health Outcome Zscore")
# Map NY Health factor Zscore
healthFactor %>%
  ggplot() +
    geom_sf(mapping = aes(fill = Z.Score.1),
                 color = NA, size = 0.05)+
    geom_sf_text(data = healthFactor, 
                aes(label = County), size = 2)+ 
  ggtitle("New York County 2020 Health Factor Zscore")

```

Darker color indicates negative Z-score and higher rank. One can conclude that counties like Nassau, Saratoga, and NYC have better health outcomes and factors than counties like Bronx, Chautauqua, or Sullivan.


## Mapping NY Covid-19 Fatality Rate
This section calculates and maps the fatality rate of each county based on cases and deaths of 2020-05-04. 
Data is downloaded from https://github.com/nytimes/covid-19-data
```{r}
# Read in COVID-19 county case and death data
county <- read.csv('us-counties.csv')
# Work with NY COVID-19 county data
NYcounty <- county[county$state=="New York",]
# Fill fips for New York City entries
NYcounty[is.na(NYcounty)] <- 36061
colnames(NYcounty)[4] <- "county_fips"
# Calculate fatality rate as to May 4th.
NYcounty <- NYcounty[NYcounty$date=="2020-05-04",]
NYcounty <- transform(NYcounty, fatality=deaths*100/cases)
# Combine geometry features to work with map
NYcounty <- transform(NYcounty, county_fips = as.character(county_fips))
NYcovid <- left_join(counties_sf, NYcounty, by = "county_fips")
# Map NY Covid-19 Fatality Rate
NYcovid %>%
  ggplot() +
    geom_sf(mapping = aes(fill = fatality),
                 color = NA, size = 0.05)+
    geom_sf_text(data = NYcovid, 
                aes(label = county), size = 2)+ 
  ggtitle("Covid-19 New York County Fatality Rate (2020-05-04)")

```

Light color indicates higher fatality rate. Counties like Tioga, Columbia, and NYC have higher fatality rate compare to counties like Allegany, Chenango, and Cortland. One can not spot direct correlations between NY counties' fatality rate and overall health outcomes and factors from the graphs. 


## Building Linear Regression Model for Fatality Rate
We want to test if health outcomes and factors data can explain changes in fatality rate. The dependent varables are continuous, and not binary varables. Thus we try building linear regression model.
```{r}
# Create dataset of fatality rate, health outcome and health factor
data <- as.data.frame(NYcounty[c("county","fatality")])
data1 <- as.data.frame(NYfactor[c("Z.Score","Z.Score.1","County")])
colnames(data1) <- cbind("outcome","factor","county")
data <- merge(x=data,y=data1,by="county")
# Build Linear Regression Model
fit <- lm(fatality ~ outcome + factor, data = data)
summary(fit)
```

R-squared is 0.2 which is below 0.6. One can conclude that NY county health outcome and factor did poorly on explaining fatality rate in the linear regression model.

## Mapping NY County Health Outcomes & Factors Subrankings
This section will map health outcomes and factors subrankings to see if there's any can serve as indicators for fatality rate. Subrankings include: length of life, quality of life, health behaviors, and clinical care, social & economic factors, and physical environment.
Data is downloaded from https://www.countyhealthrankings.org/.
```{r}
# Read in the NY county subrankings data
NYsubrank <- read.csv('NY2020CountySubrankings.csv')
# Convert fips column from numeric type to character
NYsubrank <- transform(NYsubrank, county_fips = as.character(county_fips))
# Combine geometry features to work with map
subrank <- left_join(counties_sf, NYsubrank, by = "county_fips")
# Map NY county length of life
subrank %>%
  ggplot() +
    geom_sf(mapping = aes(fill = Length.of.Life),
                 color = NA, size = 0.05)+
    geom_sf_text(data = subrank, 
                aes(label = County), size = 2)+ 
  ggtitle("New York County 2020 Length of Life Zscore")
# Map NY county quality of life
subrank %>%
  ggplot() +
    geom_sf(mapping = aes(fill = Quality.of.Life),
                 color = NA, size = 0.05)+
    geom_sf_text(data = subrank, 
                aes(label = County), size = 2)+ 
  ggtitle("New York County 2020 Quality of Life Zscore")
# Map NY county Health Behaviors
subrank %>%
  ggplot() +
    geom_sf(mapping = aes(fill =Health.Behaviors),
                 color = NA, size = 0.05)+
    geom_sf_text(data = subrank, 
                aes(label = County), size = 2)+ 
  ggtitle("New York County 2020 Health Behaviors Zscore")
# Map NY county Clinical Care 
subrank %>%
  ggplot() +
    geom_sf(mapping = aes(fill = Clinical.Care ),
                 color = NA, size = 0.05)+
    geom_sf_text(data = subrank, 
                aes(label = County), size = 2)+ 
  ggtitle("New York County 2020 Clinical Care Zscore")
# Map NY county Social and Economic Factors 
subrank %>%
  ggplot() +
    geom_sf(mapping = aes(fill = Social.and.Economic.Factors ),
                 color = NA, size = 0.05)+
    geom_sf_text(data = subrank, 
                aes(label = County), size = 2)+ 
  ggtitle("New York County 2020 Social and Economic Factors Zscore")
# Map NY county Social and Economic Factors 
subrank %>%
  ggplot() +
    geom_sf(mapping = aes(fill = Social.and.Economic.Factors ),
                 color = NA, size = 0.05)+
    geom_sf_text(data = subrank, 
                aes(label = County), size = 2)+ 
  ggtitle("New York County 2020 Social and Economic Factors Zscore")
# Map NY county Physical Environment 
subrank %>%
  ggplot() +
    geom_sf(mapping = aes(fill = Physical.Environment ),
                 color = NA, size = 0.05)+
    geom_sf_text(data = subrank, 
                aes(label = County), size = 2)+ 
  ggtitle("New York County 2020 Physical Environment Zscore")

``` 

One can not spot direct correlations between NY counties' fatality rate and subrankings of health outcomes and factors from the graphs.

## Mapping NY County Measures
This section maps some measures that may be related to Covid-19 Fatality rate including percentage smokers, income inequality, and social association. 
```{r}
# Read in the NY county measure data
NYmeasure <- read.csv('NY2020CountyMeasure.csv')
# Convert fips column from numeric type to character
NYmeasure <- transform(NYmeasure, county_fips = as.character(county_fips))
# Combine geometry features to work with map
measure <- left_join(counties_sf, NYmeasure, by = "county_fips")
# Map NY county percentage smokers
measure %>%
  ggplot() +
    geom_sf(mapping = aes(fill = X..Smokers),
                 color = NA, size = 0.05)+
    geom_sf_text(data = measure, 
                aes(label = County), size = 2)+ 
    labs(fill = "Percentage Smokers") +
  ggtitle("New York County 2020 Percentage Smokers")
# Map NY county Income Inequality
measure %>%
  ggplot() +
    geom_sf(mapping = aes(fill = Z.Score.25),
                 color = NA, size = 0.05)+
    geom_sf_text(data = measure, 
                aes(label = County), size = 2)+ 
    labs(fill = "Income Inequality Zscore") +
  ggtitle("New York County 2020 Income Inequality Zscore")
# Map NY county Social Association
measure %>%
  ggplot() +
    geom_sf(mapping = aes(fill = Z.Score.27),
                 color = NA, size = 0.05)+
    geom_sf_text(data = measure, 
                aes(label = County), size = 2)+ 
    labs(fill = "Social Association Zscore") +
  ggtitle("New York County 2020 Social Association Zscore")
```

One can not spot direct correlations between NY counties' fatality rate and these measures.

## Mapping NY County Additional Measures
This section maps some additional measures that may be related to Covid-19 Fatality rate including percentage adults with diabetes, percentage uninsured adults, median household income, and average traffic volume per meter of major roadways. 
```{r}
# Read in the NY county Additional measure data
NYAddmeasure <- read.csv('NY2020CountyAddMeasure.csv')
# Convert fips column from numeric type to character
NYAddmeasure <- transform(NYAddmeasure, county_fips = as.character(county_fips))
# Combine geometry features to work with map
Addmeasure <- left_join(counties_sf, NYAddmeasure, by = "county_fips")
# Map NY county Percentage Adults with Diabetes
Addmeasure %>%
  ggplot() +
    geom_sf(mapping = aes(fill = X..Adults.with.Diabetes),
                 color = NA, size = 0.05)+
    geom_sf_text(data = measure, 
                aes(label = County), size = 2)+ 
    labs(fill = "Percentage Adults with Diabetes") +
  ggtitle("New York County 2020 Percentage Adults with Diabetes")
# Map NY county Percentage Uninsured Adults
Addmeasure %>%
  ggplot() +
    geom_sf(mapping = aes(fill = X..Uninsured.1),
                 color = NA, size = 0.05)+
    geom_sf_text(data = measure, 
                aes(label = County), size = 2)+ 
    labs(fill = "Percentage Uninsured Adults") +
  ggtitle("New York County 2020 Percentage Uninsured Adults")
# Map NY county Median Household Income
Addmeasure %>%
  ggplot() +
    geom_sf(mapping = aes(fill = Median.Household.Income),
                 color = NA, size = 0.05)+
    geom_sf_text(data = measure, 
                aes(label = County), size = 2)+ 
    scale_fill_gradientn(labels = scales::dollar) +
    labs(fill = "Median Household Income") +
  ggtitle("New York County 2020 Median Household Income")
# Map NY county traffic volume
Addmeasure %>%
  ggplot() +
    geom_sf(mapping = aes(fill = Average.Traffic.Volume.per.Meter.of.Major.Roadways),
                 color = NA, size = 0.05)+
    geom_sf_text(data = measure, 
                aes(label = County), size = 2)+ 
    labs(fill = "Average Traffic Volume per Meter of Major Roadways") +
  ggtitle("Average Traffic Volume per Meter of Major Roadways")
```

One can not spot direct correlations between NY counties' fatality rate and these additional measures.

## Building Linear Regression Model with Measures

We want to test if the above measures can explain changes in fatality rate by building linear regression model.
```{r}
# Create dataset of fatality rate, health outcome and health factor
data2 <- as.data.frame(NYcounty[c("county","fatality")])
data3 <- as.data.frame(NYmeasure[c("X..Smokers","Z.Score.25","Z.Score.27","County")])
data4 <- as.data.frame(NYAddmeasure[c("X..Adults.with.Diabetes","X..Uninsured.1",
                                      "Median.Household.Income",
                                      "Average.Traffic.Volume.per.Meter.of.Major.Roadways","County")])

colnames(data3) <- cbind("smoker","income_inequality","social_association","county")
colnames(data4) <- cbind("diabete","uninsured","MHI","traffic","county")
data5 <- merge(x=data2,y=data3,by="county")
data6 <- merge(x=data5,y=data4,by="county")
# Build Linear Regression Model for percentage smoker
fit2 <- lm(fatality ~ smoker, data = data6)
summary(fit2)
# Build Linear Regression Model for income inequality
fit3 <- lm(fatality ~ income_inequality, data = data6)
summary(fit3)
# Build Linear Regression Model for social association
fit4 <- lm(fatality ~ social_association, data = data6)
summary(fit4)
# Build Linear Regression Model for percentage diabete
fit5 <- lm(fatality ~ diabete, data = data6)
summary(fit5)
# Build Linear Regression Model for percentage uninsured adults
fit6 <- lm(fatality ~ uninsured, data = data6)
summary(fit6)
# Build Linear Regression Model for median household income
fit7 <- lm(fatality ~ MHI, data = data6)
summary(fit7)
# Build Linear Regression Model for traffic volume
fit8 <- lm(fatality ~ traffic, data = data6)
summary(fit8)
```

R-squred value for the tested seven measures are all below 0.6, indicating that these measures did poorly on explaining fatality rate. 

## Conclusion and Discussion
Based on the results, NY county level fatality rate can not be explained by health outcomes and factors like percentage smokers, percentage adults with diabetes, etc. These factors may have higher explanatory power in predicting individual cases. But when modeling the disease at a county level, it is possible that other factors like amount of necessary medical equipments, number of nurses avaliable, percentage of people practicing safe social distancing may have better explanatory power. However, these data can not be easily obtained. Future work can be carried into a different direction. One may be interested looking at correlations between social factors and the recover rates at county level.  

