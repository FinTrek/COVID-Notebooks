---
title: "ProtoNotebook"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```




```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_knit$set(root.dir = "../")
```

```{r echo = F, results = 'hide',  warning=FALSE, message=FALSE}
#### Library and Data Imports ####
## Load essential R packages
source("Modules/Source.R")
## Load in model outputs per state:
source("Modules/load_model_output.R")
```

```{r echo = F, results = 'hide',  warning=FALSE, message=FALSE}
### P_value Table explanation
per_state_p_vals <- "<h4><b>Color-coordinate P-Value Summaries per parameter in the model per state?</b></h4>
Here, <span style='color:#c35442'><b>red</b></span> indicate non-significance (p > 0.10)<br><br> 
<span style='color:#d58570'><b>light red</b></span> indicate significance (0.05 < p < 0.10)<br><br> 
<span style='color:#d4e6e8'><b>light blue</b></span> indicate significance (0.01 < p < 0.05)<br><br> 
<span style='color:#94c0c6'><b>blue</b></span> indicate significance (p < 0.01)<br><br>"

```

  `r per_state_p_vals`

```{r echo = F}


  color_format <- function(x, na.rm = TRUE) {
  
  ifelse(x >0.10,
         
         cell_spec(x, "html", background = "#c35442", color = "#000000"),  # RED (over .1)
         ifelse(x>0.05,
                cell_spec(x, "html", background ="#d58570", color = "#000000"),  # (over .05)
                ifelse(x>0.01,
                       cell_spec(x, "html", background ="#d4e6e8", color = "#000000"), # (over .01)
                       cell_spec(x, "html", background ="#94c0c6", color = "#000000")))) # (under .01)
  
  }
  rounder <- function(x, na.rm = TRUE) {
    round(x, digits = 3)
  }
  
  t2 <- as_tibble(states.all_p)
  
  t2 %>%
  mutate_if(is.double, rounder, na.rm = TRUE) %>%
  mutate_if(is.double, color_format, na.rm = TRUE) %>%
  kable(format = "html", escape = F, row.names = TRUE) %>%
  kable_styling(full_width = T) 
  
  t2
```




```{r echo = F}
  
# p_value heatmap 

  t2 <- as_tibble(as.data.frame(apply(states.all_p, 2, as.numeric)))
  t3 <- as_tibble(states.all_p)
  
  
  t2 <- dplyr::select(t2, -c("coefficients"))
  t2 <- as.matrix(t2)
  for ( i in 1:dim(t2)[1]){
    for ( k in 1:dim(t2)[2]) {
      if  ( !is.na(t2[i,k]) &&  t2[i,k] < 0.05 ) {
        t2[i,k] = 0.0   # if the value is significant, floor it to 0 to "highlight" it as red on the heatmap
      } 
    }
  }
  heatmap.2(t2, main = "Pvals StateSummary Heatmap", xlab = "State", ylab = "factor", trace = 'none', na.color = "black", labCol = colnames(t2), labRow = t3$coefficients)


```

```{r echo = F}
  

  set_na_2_1 <- function(x, na.rm = FALSE) {
    x = 1.000
  }  

  state_c <- as_tibble(as.data.frame(apply(states.all_c, 2, as.numeric)))
  state_c <- dplyr::select(state_c, -c("coefficients"))
  state_c <- as.matrix(state_c)
  state_p <- as_tibble(as.data.frame(apply(states.all_p, 2, as.numeric)))
  state_p <- dplyr::select(state_p, -c("coefficients"))
  state_p <- as.matrix(state_p)
  t3 <- as_tibble(states.all_p)
  state_heat <- matrix(nrow = dim(state_p)[1] , ncol = dim(state_p)[2])
  

  
  for ( i in 1:dim(state_p)[1]){
    for ( k in 1:dim(state_p)[2]) {
      if (is.na(state_p[i,k])){
        state_heat[i,k] = NA
      } else if (state_p[i,k] < 0.05) {
        if (state_c[i,k] < 1.0) {
          state_heat[i,k] = 0.0
        } else if (state_c[i,k] > 1.0){
          state_heat[i,k] = 1
        } else {
          state_heat[i,k] = 0.5
        }
      } else { # grey val, heat = 0.5
        state_heat[i,k] = 0.5
     }
    }
  }
 
  
  color_palette <- colorRampPalette(c("blue", "grey", "red"))(n = 3)
  
  heatmap.2(state_heat, col = color_palette, main = "Effect on MRR per variable per state", xlab = "State", ylab = "factor", trace = 'none', na.color = "black", labCol = colnames(state_p), labRow = t3$coefficients, offsetRow = 1, margins = c(8,16))


```





# Normalize MRRs to MR by subtracting 1 and dividing by stdev for each state... output as table


```{r echo = F}
  
  state_c <- as.data.frame(states.all_c)
  coefs <- state_c$coefficients
  
  coefs_clean <- c("hispanic", "pct_blk", "pct_asian", "pct_white", "pct_native", "pct_age65", "medhouseholdincome", "pct_obesity", "pct_diabetes", "LungCancer", "COPD", "AdultAsthma", "PediatricAsthma", "All.Cause.death_rate", "state")
  states <- c("AL", "AR", "AZ", "CA", "CT","CO", "DE", "FL", "GA", "IA", "ID", "IL", "IN", "KS", "KY",
            "LA", "MA", "MD", "ME", "MI", "MN", "MO", "MS", "MT", "NC", "ND", "NE", "NH", "NM", "NJ", "NV", 
            "NY", "OH", "OK", "OR", "PA", "SC", "SD", "TN", "TX", "UT", "VA", "VT", "WA", "WI", "WV", "WY")
  
  # Split the data on state
  statesplit <- split(model_input, model_input$state)

  # Ignore states with less than 2 counties
  for (name in names(statesplit)) {
    if (nrow(statesplit[[name]]) < 2){
      statesplit <- statesplit[names(statesplit) != name]
    }
  }
  
  state_MRs <- array(dim = c(length(states),length(coefs)))
  
  
  for (i in 1:length(names(statesplit))) {
    name = names(statesplit)[i]
    # Ignore states having issues
    if (name %in% c("AZ", "CT", "DE", "RI"))
      next
    state_data <- statesplit[[name]]
      
    state_data <- subset(state_data, select = c(fips, Deaths, hispanic, pct_blk, pct_asian, pct_white, pct_native, medhouseholdincome, pct_obesity, pct_age65, pct_diabetes, LungCancer, AdultChronicLungDisease, COPD, AdultAsthma, PediatricAsthma,  Despair.death_rate, All.Cause.death_rate, Cardiovascular.death_rate, population))
    
    b <- paste(name, ".summary", sep= "")
    model_output <- eval(as.name(b))
    this_state_Cs <- model_output$coefficients[,1]
    names <- names(this_state_Cs)
    this_state_Cs <- unname(this_state_Cs)
    
    if (!(name %in% states)) {
      print(name)
      next
    }
    
    this_state_MRs <- array(dim = c(length(coefs)))
    
    for ( j in 1:length(names)) {
      coef = names[j] 
      sdev <- case_when (
        coef == "scale(hispanic)"                ~ sd(state_data$hispanic) ,
        coef == "scale(pct_blk)"                 ~ sd(state_data$pct_blk) ,
        coef == "scale(pct_asian)"               ~ sd(state_data$pct_asian) ,
        coef == "scale(pct_white)"               ~ sd(state_data$pct_white) ,
        coef == "scale(pct_native)"              ~ sd(state_data$pct_native) ,
        coef == "scale(pct_age65)"               ~ sd(state_data$pct_age65) ,
        coef == "scale(log(medhouseholdincome))" ~ sd(state_data$medhouseholdincome) ,
        coef == "scale(pct_obesity)"             ~ sd(state_data$pct_obesity) ,
        coef == "scale(pct_diabetes)"            ~ sd(state_data$pct_diabetes) ,
        coef == "scale(LungCancer)"              ~ sd(state_data$LungCancer) ,
        coef == "scale(COPD)"                    ~ sd(state_data$COPD) ,
        coef == "scale(AdultAsthma)"             ~ sd(state_data$AdultAsthma) ,
        coef == "scale(PediatricAsthma)"         ~ sd(state_data$PediatricAsthma) ,
        coef == "scale(All.Cause.death_rate)"    ~ sd(state_data$All.Cause.death_rate),
        TRUE                                     ~ -100
      )
      if (!is.na(sdev) && sdev != -100) {
        this_state_MRs[which(coefs %in% c(coef))] = (this_state_Cs[j]-1.0)/sdev
      }
    }
    if (length(state_MRs[which(states %in% c(name)),]) != length(this_state_MRs)) {
      #print(length(state_MRs[which(states %in% c(name)),]))
      #print(length(this_state_MRs))
      stop()
    } else {
      state_MRs[which(states %in% c(name)),] = this_state_MRs
    }
  }
  
  
  state_MRs
  t0 <- as.data.frame(state_MRs)
  t1 <- as_tibble(t0)
  
  t1
  
  stop()
  
  colnames(t1) <- as.character(coefs)
  colnames(t1)
  length(states)
  t2 <- t1 %>% 
    mutate(state = states)
  t2
  saveRDS(t2, "states_normalize.rds")


```

```{r echo = F}
  
    nat <- national
    coefs <- row.names(nat$coefficients)
  
    mo_in <-subset(model_input, select = c(fips, Deaths, hispanic, pct_blk, pct_asian, pct_white, pct_native, medhouseholdincome, pct_obesity, pct_age65, pct_diabetes, LungCancer, AdultChronicLungDisease, COPD, AdultAsthma, PediatricAsthma,  Despair.death_rate, All.Cause.death_rate, Cardiovascular.death_rate, population)) 
  
    nat_Cs <- nat$coefficients[,1]
    names <- names(nat_Cs)
    
    nat_MRs <- array(dim = c(length(coefs)))
    
    for ( j in 1:length(names)) {
      coef = names[j] 
      sdev <- case_when (
        coef == "scale(hispanic)"                ~ sd(mo_in$hispanic) ,
        coef == "scale(pct_blk)"                 ~ sd(mo_in$pct_blk) ,
        coef == "scale(pct_asian)"               ~ sd(mo_in$pct_asian) ,
        coef == "scale(pct_white)"               ~ sd(mo_in$pct_white) ,
        coef == "scale(pct_native)"              ~ sd(mo_in$pct_native) ,
        coef == "scale(pct_age65)"               ~ sd(mo_in$pct_age65) ,
        coef == "scale(log(medhouseholdincome))" ~ sd(mo_in$medhouseholdincome) ,
        coef == "scale(pct_obesity)"             ~ sd(mo_in$pct_obesity) ,
        coef == "scale(pct_diabetes)"            ~ sd(mo_in$pct_diabetes) ,
        coef == "scale(LungCancer)"              ~ sd(mo_in$LungCancer) ,
        coef == "scale(COPD)"                    ~ sd(mo_in$COPD) ,
        coef == "scale(AdultAsthma)"             ~ sd(mo_in$AdultAsthma) ,
        coef == "scale(PediatricAsthma)"         ~ sd(mo_in$PediatricAsthma) ,
        coef == "scale(All.Cause.death_rate)"    ~ sd(mo_in$All.Cause.death_rate),
        TRUE                                     ~ -100
      )
      if (!is.na(sdev) && sdev != -100) {
        nat_MRs[which(coefs %in% c(coef))] = (nat_Cs[j]-1.0)/sdev
      }
    }

    t1 <- as_tibble(nat_MRs)
    
    t2 <- t1 %>%
      mutate(coefficients = names)
    saveRDS(t2, "national_normalize.rds")

```