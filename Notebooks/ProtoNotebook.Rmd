---
title: "ProtoNotebook"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```




```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_knit$set(root.dir = "../")
```

```{r echo = F, results = 'hide',  warning=FALSE, message=FALSE}
#### Library and Data Imports ####
## Load essential R packages
source("Modules/Source.R")
## Load in model outputs per state:
source("Modules/load_model_output.R")
```

```{r echo = F, results = 'hide',  warning=FALSE, message=FALSE}
### P_value Table explanation
per_state_p_vals <- "<h4><b>Color-coordinate P-Value Summaries per parameter in the model per state?</b></h4>
Here, <span style='color:#c35442'><b>red</b></span> indicate non-significance (p > 0.10)<br><br> 
<span style='color:#d58570'><b>light red</b></span> indicate significance (0.05 < p < 0.10)<br><br> 
<span style='color:#d4e6e8'><b>light blue</b></span> indicate significance (0.01 < p < 0.05)<br><br> 
<span style='color:#94c0c6'><b>blue</b></span> indicate significance (p < 0.01)<br><br>"

```

  `r per_state_p_vals`

```{r echo = F}


  color_format <- function(x, na.rm = TRUE) {
  
  ifelse(x >0.10,
         
         cell_spec(x, "html", background = "#c35442", color = "#000000"),  # RED (over .1)
         ifelse(x>0.05,
                cell_spec(x, "html", background ="#d58570", color = "#000000"),  # (over .05)
                ifelse(x>0.01,
                       cell_spec(x, "html", background ="#d4e6e8", color = "#000000"), # (over .01)
                       cell_spec(x, "html", background ="#94c0c6", color = "#000000")))) # (under .01)
  
  }
  rounder <- function(x, na.rm = TRUE) {
    round(x, digits = 3)
  }
  
  t2 <- as_tibble(states.all_p)
  
  t2 %>%
  mutate_if(is.double, rounder, na.rm = TRUE) %>%
  mutate_if(is.double, color_format, na.rm = TRUE) %>%
  kable(format = "html", escape = F, row.names = TRUE) %>%
  kable_styling(full_width = T) 
  
  t2
```




```{r echo = F}
  
# p_value heatmap 

  t2 <- as_tibble(as.data.frame(apply(states.all_p, 2, as.numeric)))
  t3 <- as_tibble(states.all_p)
  
  
  t2 <- dplyr::select(t2, -c("coefficients"))
  t2 <- as.matrix(t2)
  t2[100]
  
  heatmap.2(t2, main = "Pvals StateSummary Heatmap", xlab = "State", ylab = "factor", trace = 'none', na.color = "black", labCol = colnames(t2), labRow = t3$coefficients)


```

```{r echo = F}
  

  set_na_2_1 <- function(x, na.rm = FALSE) {
    x = 1.000
  }  

  state_c <- as_tibble(as.data.frame(apply(states.all_c, 2, as.numeric)))
  state_c <- dplyr::select(state_c, -c("coefficients"))
  state_c <- as.matrix(state_c)
  state_p <- as_tibble(as.data.frame(apply(states.all_p, 2, as.numeric)))
  state_p <- dplyr::select(state_p, -c("coefficients"))
  state_p <- as.matrix(state_p)
  t3 <- as_tibble(states.all_p)
  state_heat <- matrix(nrow = dim(state_p)[1] , ncol = dim(state_p)[2])
  

  
  for ( i in 1:dim(state_p)[1]){
    for ( k in 1:dim(state_p)[2]) {
      if (is.na(state_p[i,k])){
        state_heat[i,k] = NA
      } else if (state_p[i,k] < 0.05) {
        if (state_c[i,k] < 1.0) {
          state_heat[i,k] = 0.0
        } else if (state_c[i,k] > 1.0){
          state_heat[i,k] = 1
        } else {
          state_heat[i,k] = 0.5
        }
      } else { # grey val, heat = 0.5
        state_heat[i,k] = 0.5
     }
    }
  }
 
    
  state_heat
  
  color_palette <- colorRampPalette(c("blue", "grey", "red"))(n = 3)
  
  heatmap.2(state_heat, col = color_palette, main = "Effect on MRR per variable per state", xlab = "State", ylab = "factor", trace = 'none', na.color = "black", labCol = colnames(state_p), labRow = t3$coefficients)


```

