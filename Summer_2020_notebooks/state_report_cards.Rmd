---
title: "State Report Cards"
author: "Jose Figueroa"
date: 06/02/20
output: html_notebook
---



```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_knit$set(root.dir = "../")
```

```{r imports, echo = F, results = 'hide',  warning=FALSE, message=FALSE}
#### Library and Data Imports ####

## Load essential R packages
source("modules/Source.R")

## Load stored data (see `data` subdirectory)
source("modules/data_load.R")

## Create dataframes; perform desparity index calcuations; prep for plotting
source("modules/preprocessing.R")

```

```{r map colors}
colors <- c("#253494","#4575B4", "#74ADD1","#ABD9E9","#f7f7f7","#FDAE61","#F46D43", "#D73027", "#BD0026")
bins <- c(5, 3, 2, 1, .2, -.2, -1, -2, -3, -5)
```

Function to be generalized
```{r get_ldi}
get_ldi <- function(feature) {
  rate <- paste0(feature,"_rate")
  ldi <- paste0(rate, "_ldi")
  return(c(ldi, rate))
}
```



```{r geo.plot}
geo.plot <- function(state.choice, feature, reverse=F) {
  # Feature: Case, Mortality...
  ldi_feature <- get_ldi(feature)
  
  dataset <- todays.case.data %>%
    filter(State == state.choice)
  shapes <- readRDS(paste("data/shape_files/", state.choice, ".Rds", sep = ""))
  shapes$countyFIPS <- as.numeric(paste(as.data.frame(shapes)$STATEFP, as.data.frame(shapes)$COUNTYFP, sep = ''))
  
  dataset <- dplyr::left_join(as.data.frame(shapes), as.data.frame(dataset), by = c("countyFIPS" = "countyFIPS"))
  
  pal2 <- leaflet::colorBin(colors, domain = dataset[,ldi_feature[1]], bins = bins, reverse=reverse)
    
  labels <- sprintf(
    paste0("<strong>%s</strong><br/>
    COVID-19 ",feature," Rate DI: %.2g<br>
    COVID-19 ",feature," Rate: %.1f /100k"),
    dataset$County, dataset[,ldi_feature[1]], (dataset[,ldi_feature[2]])*100000
  ) %>% lapply(htmltools::HTML)
  

  return (leaflet(shapes) %>%
  addPolygons(
    fillColor = ~pal2(dataset[,ldi_feature[1]]),
    weight = 1,
    opacity = 1,
    color = "#330000",
    dashArray = "1",
    fillOpacity = 0.7,
    highlight = highlightOptions(
      weight = 5,
      color = "#666",
      dashArray = "",
      fillOpacity = 0.7,
      bringToFront = TRUE),
    label = labels,
    labelOptions = labelOptions(
      style = list("font-weight" = "normal", padding = "3px 8px"),
      textsize = "15px",
      direction = "auto")) %>% 
  addLegend(pal = pal2, 
            values = ~dataset[ldi_feature[1]], 
            opacity = 0.7, 
            title = paste0("Disparity Index<br/>",state.choice," COVID-19 ",feature," Rates"),
            position = "bottomright",
            labFormat = function(type, cuts, p) { n = length(cuts) 
            cuts[n] = paste0(cuts[n]," lower") 
            # for (i in c(1,seq(3,(n-1)))){cuts[i] = paste0(cuts[i],"—")} 
            for (i in c(1,seq(2,(n-1)))){cuts[i] = paste0(cuts[i]," — ")} 
            cuts[2] = paste0(cuts[2]," higher") 
            paste0(str_remove(cuts[-n],"higher"), str_remove(cuts[-1],"—"))
            }
  ) %>%
  addProviderTiles("MapBox", options = providerTileOptions(
    id = "mapbox.light"))
    )
}

```

covid_confirmed_usafacts metadata:
+ countyFIPS: 0 for statewide unallocated, 1 for NYC unallocated, otherwise>1000
+ County Name: Format is "x County", i.e. "Albany County"
+ State: 2 letter initial
+ stateFIPS: 1-56
+ 1/22/20..MostRecentDate: Time series case data (aggregate)

NY.data (to replicate):
+ 10 NY.shape columns (inner join on county fips?)
+ County: County Name without 'County' in strings
+ Population
+ Date
+ Cases/Case Rate/LDI (Basically any data I want to show)

Population
+ countyFIPS: 0 for statewide unallocated, 1 for NYC unallocated, otherwise>1000
+ County Name: Format is "x County", i.e. "Albany County"
+ State: 2 letter initial
+ Population: of county

covid_deaths_usafacts metadata:
+ countyFIPS: 0 for statewide unallocated, 1 for NYC unallocated, otherwise>1000
+ County Name: Format is "x County", i.e. "Albany County"
+ State: 2 letter initial
+ stateFIPS: 1-56
+ 1/22/20..MostRecentDate: Time series case data (aggregate)


```{r data processing}

todays.raw.case.data <- read_csv("data/csv/time_series/covid_confirmed_usafacts.csv") 

todays.case.data <- todays.raw.case.data %>%
  filter(countyFIPS > 1000) %>%
  select(countyFIPS, `County Name`, State, ncol(todays.case.data)) %>%
  rename(c("County" = "County Name"))
colnames(todays.case.data)[4] <- "Cases"

population <- read_csv("data/csv/time_series/covid_county_population_usafacts.csv") %>%
  filter(countyFIPS > 1000)

todays.case.data <- inner_join(todays.case.data, population[c(1,4)], by=c("countyFIPS" = "countyFIPS")) %>%
  filter(population > 0)

todays.raw.death.data <- read_csv("data/csv/time_series/covid_deaths_usafacts.csv")
todays.death.data <- todays.raw.death.data %>%
  filter(countyFIPS > 1000) %>%
  select(1, ncol(todays.raw.death.data))
colnames(todays.death.data)[2] <- "Mortality"

todays.case.data <- inner_join(todays.case.data, todays.death.data, by=c("countyFIPS" = "countyFIPS"))

todays.case.data$Case_rate <- todays.case.data$Cases/todays.case.data$population
todays.case.data$Case_rate_ldi <- unlist(lapply(todays.case.data$Case_rate, FUN=function(x){-log(pUS.6.cases/x)})) 
todays.case.data <- todays.case.data %>%
 mutate(Case_rate_ldi = replace(Case_rate_ldi, Case_rate_ldi < -5, -5))

todays.case.data$Mortality_rate <- todays.case.data$Mortality/todays.case.data$population
todays.case.data$Mortality_rate_ldi <- unlist(lapply(todays.case.data$Mortality_rate, FUN=function(x){-log(pUS.6.deaths/x)}))
todays.case.data <- todays.case.data %>%
 mutate(Mortality_rate_ldi = replace(Mortality_rate_ldi, Mortality_rate_ldi < -5, -5))

todays.case.data <- todays.case.data %>%
  mutate(County = str_remove_all(County, regex(" County", ignore_case = T)))

```

```{r Cases}
selected_state <- "NY"
selected_feature <- "Case"
geo.plot(selected_state, selected_feature)
```

```{r Mortality}
selected_state <- "NY"
selected_feature <- "Mortality"
geo.plot(selected_state, selected_feature)
```

```{r}
state_policy <- read_csv("Summer_2020_notebooks/state_policy.csv")
state_policy.df <- state_policy[5:55,]
state_policy.md <- state_policy[1:4,]
state_policy.df
as.Date(state_policy.df$STAYHOME, format = "%m/%d/%y")
state_policy.df[as.vector(state_policy.md[4,] == "date")] <- lapply(state_policy.df[as.vector(state_policy.md[4,] == "date")], function(x){as.Date(x, format = "%m/%d/%y")})
```

```{r plot processing}
covid_TS_counties_long.cases <- todays.raw.case.data %>%
  tidyr::gather(date,cases,5:ncol(todays.raw.case.data))
covid_TS_counties_long.death <- todays.raw.death.data %>%
  tidyr::gather(date,deaths,5:ncol(todays.raw.death.data))

# Make date column an actual R date_time
covid_TS_counties_long.cases$date <- parse_date_time(covid_TS_counties_long.cases$date, c("%m/%d/%y"))
covid_TS_counties_long.death$date <- parse_date_time(covid_TS_counties_long.death$date, c("%m/%d/%y"))

# Factor does not make sense here as there may be distint, same named counties
covid_TS_counties_long.cases <- covid_TS_counties_long.cases %>%
  rename(County = `County Name`) %>%
  mutate(County = str_remove_all(County, regex(" County", ignore_case = T)))

# Join death data
covid_TS_counties_long.cases <- inner_join(covid_TS_counties_long.cases, covid_TS_counties_long.death[c(1,5,6)], by=c("countyFIPS" = "countyFIPS", "date" = "date"))

# Filter small data
covid_TS_counties_long.cases <- covid_TS_counties_long.cases %>%
  filter(countyFIPS > 1000) %>%
  filter(cases > 5)

# Join population data
covid_TS_counties_long.cases <- left_join(covid_TS_counties_long.cases, population[c(1,4)], by=c("countyFIPS" = "countyFIPS"))

# Per100k columns
covid_TS_counties_long.cases$p_cases <- covid_TS_counties_long.cases$cases/covid_TS_counties_long.cases$population*100000

covid_TS_counties_long.cases$p_deaths <- covid_TS_counties_long.cases$deaths/covid_TS_counties_long.cases$population*100000

covid_TS_counties_long.cases %>% group_by(County, State) %>% 
  mutate(diff = ifelse(as.Date(date - 1) == lag(date), cases - lag(cases), cases)) -> 
  covid_TS_counties_long.cases

covid_TS_counties_long.cases %>% 
  mutate(p_diff = ifelse(as.Date(date - 1) == lag(date), p_cases - lag(p_cases), p_cases)) %>%
  ungroup() -> covid_TS_counties_long.cases

covid_TS_counties_long.cases$diff <- ifelse(is.na(covid_TS_counties_long.cases$diff), covid_TS_counties_long.cases$cases, covid_TS_counties_long.cases$diff)
covid_TS_counties_long.cases$p_diff <- ifelse(is.na(covid_TS_counties_long.cases$p_diff), covid_TS_counties_long.cases$p_cases, covid_TS_counties_long.cases$p_diff)
```


```{r}
selected_state <- "GA"
covid_TS_counties.cases.plot <- covid_TS_counties_long.cases %>%
  filter(State == selected_state)

county.num <- unique(covid_TS_counties.cases.plot$County) %>% as.data.frame()
colnames(county.num) <- c("County")
county.num <- county.num %>%
  mutate(num = row_number())

n_case_cut <- 10

highlight_points <- covid_TS_counties.cases.plot  %>%
  left_join(county.num, by=c("County" = "County")) %>%
  filter(cases > n_case_cut*n_county) %>%
  group_by(County) %>%
  mutate(range = as.numeric(as.Date(max(date))) - as.numeric(as.Date(min(date)))) %>%
  mutate(min_date = as.Date(min(date))) %>%
  mutate(min_date = min_date + ((num*((range%/%n_county)))%%range))  %>%
  filter(date == min_date) %>%
  top_n(1, wt=min_date)


g <- covid_TS_counties.cases.plot %>%
  filter(cases > n_case_cut*n_county) %>%
ggplot(aes(date, 
           cases, 
           color = County,
           group = County)) +
      geom_line(size=1) +
      scale_y_continuous(
        trans = "log10",
        breaks = c(10,100,500,1000,5000,10000, 50000)
      ) +
      scale_x_datetime(date_breaks = "1 week", date_minor_breaks = "1 day", date_labels = "%b %d") +
      ylab("Cases") + 
      xlab("Date") +
      theme(legend.position = "none") +
      geom_label_repel(
        data=highlight_points,  
        aes(label=County,fill=County), 
        box.padding = unit(1.75, 'lines'),
        color = "black",
        segment.color = "black",
        size = 5,
        show.legend = FALSE
      ) +
      ggtitle(paste0(selected_state, " cases over time"))  +
      # geom_vline(aes(xintercept=as_datetime("2020-03-20"), linetype="Gov. Cuomo issues stay-at-home order"), color = "black") + 
      #scale_linetype_manual(name = "Events", 
      #                      values = c(2,2), 
      #                      guide = guide_legend(override.aes = list(color = c("blue","black")))) +
      NULL
g
```

